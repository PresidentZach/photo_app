<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PhotoSynthesis</title>
  {% load static %}
 <link rel="stylesheet" href="{% static 'styles.css' %}">
 <script src="{% static 'index.js' %}"></script>
 <body onload="displayPhotos()">
</head>
<body>

  <!-- Top bar with logo and logout -->
  <header>
    <div class="logo">PhotoSynthesis</div>
    <div class="account">
      <!-- If the user is logged in display logout -->
      {% if logged_in %}
        <a href="{% url 'logout' %}">Logout</a> 
      {% else %}
        <a href="{% url 'login' %}">Login</a>
      {% endif %}

    </div>
  </header>

  <div class="main">
    <nav>
      <!-- Sidebar with search and links -->
      <div class="search-bar">
        <input type="text" placeholder="Search...">
      </div>
      <ul>
        <li>* Favorites</li>
        <li> Tags</li>
        <li> Upload</li> <!-- Only keeping needed links -->
      </ul>

      <!-- Upload area -->
      <div class="upload-area">
	  
         <!--Creating a form. When upload button is pressed, upload_image(request) in views.py is ran-->
		<form method="POST" enctype="multipart/form-data" action="{% url 'index' %}">
			{% csrf_token %}
				<label for="photoUpload">Upload Photos:</label>
					<br></br>
				<input type="file" name="image" accept="image/png, image/jpeg, image/jpg" multiple required>
					<br></br>
				<button type="submit">Upload</button>
		</form>
		{% if image_data %}
		    <h2>Upload Status</h2>
        <h2>Tags:</h2>
    {% endif %}

			{% if error %}
				<p style="color: red;">{{ error }}</p>
			{% else %}
				
				<ul>
					{% for image_data in images_data %}
						<li><strong>{{ image_data.name }} - URL: {{ image_data.url }}</strong></li>
						<ul>
							{% for tag, score in image_data.tags_and_scores %}
								<li>{{ tag }} - Score: {{ score }}</li>
							{% endfor %}
						</ul>
					{% endfor %}
				</ul>
			{% endif %}
      </div>
	  
    </nav>
    <div class="content">
      <h2>Photo Gallery</h2>

      <!-- Flexbox Image Grid -->
      <div id = "grid" class="image-grid">

        <!-- Function that opens image-detail div when the current img-box is clicked. -->
        <script>
        function displayInfo(photoID) {
          var name = photoID.id;
          var imgDetail = document.getElementById("image-detail");
          imgDetail.style.display = "block";
          var imgInfo  = document.getElementById("" + name + "_info").innerHTML; 

          const infoArray = imgInfo.split(";");
          document.getElementById("currentid").innerHTML = infoArray[0];
          document.getElementById("full").innerHTML='<img class = "full-img" src = "' + infoArray[1] + '" >';
          document.getElementById("tags").innerHTML = infoArray[2];
          document.getElementById("date").innerHTML = infoArray[4];

          // Logic for favorited images displaying the correct icons
          if (infoArray[3] == "True") {
            fav = document.getElementById("star");
            star.style.background = 'url("/static/fav.png")';
          }
          document.getElementById("")

        }
       </script>

         <!-- For each photo in the photo_list, make an image-box div. -->
          
         {% for photo in photo_list %}
          <div class="image-box" id= "{{photo.id}}" onclick= "displayInfo(this)">
            <img class= "thumb" src={{ photo.url }}>
          </div>
          <div class="info hidden" id="{{photo.id}}_info">{{photo.id}};{{ photo.url }};{{photo.tags}};{{photo.is_favorited}};{{photo.date_created}}</div>
         {% endfor %}
      </div>

      <!-- Hidden area for photo details -->

      <!-- Script for buttons on  image-detail div -->
       <script>
        // Closes the image-detail div.
        function closeInfo() {
          var imgDetail = document.getElementById("image-detail");
          imgDetail.style.display = "none";
        }

        function toggleFav() {
          // Get the id and set the value of the button to be that id.
          curr = document.getElementById(currentid).innerHTML;
          document.getElementById(star).value = curr;

          // Add or remove the "favorite" attribute to this image.
            
          // Update the image of this button accordingly.

          //Fetch the set_favorite view in views.py, which updates the is_favorited value.

    
        }

        function deleteImage() {
            if (confirm("Are you sure you would like to delete this image?")) {
              //Delete the image from the database.
              //Close the image-detail menu.
                var imgDetail = document.getElementById("image-detail");
                imgDetail.style.display = "none";
            } else {
              //Don't do anything.
            }
            
        }

        function editTag() {
          // Gives the user a dialog popup that allows them to add or remove tags.
          let text;
          let newTags = prompt("What tags would you like to add?", "");
          if (newTags == null || person == "") {
            //Don't do anything.
          } else {
            // Add new tags to the image.
          }
          
        }

       </script>

       <!-- Image-detail div with photo and tags-->
      <div class="image-detail hidden" id="image-detail">

        <div class= "detailmenu">
          <!-- hidden photo id that we can easily get/pass-->
           <p id="currentid" class = "hidden"></p>

          <!-- Close the image-detail div.-->
          <button class="detailbutton" id = "close" onclick = "closeInfo()">

          <!-- Toggle the image's is_favorited property.-->

            <!-- Create a form that links to the set_favorite function-->
              <form method="POST" action="{% url 'set_favorite' %}">
                {% csrf_token %}

                <button class="detailbutton" id = "star" value="currentid" onclick = "toggleFav()">
                <!-- Pass this to views.py fn -->
                <!-- Update the icon -->
              </form>

          <!-- Add a tag to the photo.-->
            <button class="detailbutton" id = "tag" onclick = "editTag()">

          <!-- Delete the image from the database.-->
          <button class="detailbutton" id = "delete" onclick = "deleteImage()">
        </div>

        <div id="full"></div>

          <div><strong>Tags:</strong>
            <span id= "tags" class="tags"></span>
          </div>
          <div><strong>Date created:</strong>
            <span id="date" class="date"></span>
        </div>
      </div>

    <script>
        // When the sidebar "Upload" is clicked, trigger the hidden file input
        document.getElementById('sidebar-upload').addEventListener('click', function () {
            document.getElementById('hidden-upload').click();
        });

        // Optional: When a file is selected, auto-submit the form or display file name
        document.getElementById('hidden-upload').addEventListener('change', function (event) {
            alert(`You selected ${event.target.files.length} file(s).`);
            // Optionally: trigger form submit here
        });
    </script>
    <script src="{% static 'js/index.js' %}"></script>

</body>
</html>
